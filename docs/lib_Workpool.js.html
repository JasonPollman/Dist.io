<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/Workpool.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-DistIO_Master-Master.html">Master</a><ul class='methods'><li data-type='method'><a href="module-DistIO_Master-Master.html#broadcast">broadcast</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#close">close</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#createParallel">createParallel</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#createPipeline">createPipeline</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#createScatter">createScatter</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#createSlave">createSlave</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#createSlaves">createSlaves</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#createWorkpool">createWorkpool</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#getSlavesWithPath">getSlavesWithPath</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#getSlaveWithAlias">getSlaveWithAlias</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#getSlaveWithId">getSlaveWithId</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#kill">kill</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#shutdown">shutdown</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#slave">slave</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#slaveBelongsToGroup">slaveBelongsToGroup</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#tellSlave">tellSlave</a></li></ul></li><li><a href="module-DistIO_Request-Request.html">Request</a><ul class='methods'><li data-type='method'><a href="module-DistIO_Request-Request.html#clearTimeout">clearTimeout</a></li><li data-type='method'><a href="module-DistIO_Request-Request.html#hasTimedout">hasTimedout</a></li><li data-type='method'><a href="module-DistIO_Request-Request.html#onTimeout">onTimeout</a></li><li data-type='method'><a href="module-DistIO_Request-Request.html#send">send</a></li></ul></li><li><a href="module-DistIO_ResponseArray-ResponseArray.html">ResponseArray</a><ul class='methods'><li data-type='method'><a href="module-DistIO_ResponseArray-ResponseArray.html#each">each</a></li><li data-type='method'><a href="module-DistIO_ResponseArray-ResponseArray.html#joinValues">joinValues</a></li><li data-type='method'><a href="module-DistIO_ResponseArray-ResponseArray.html#push">push</a></li><li data-type='method'><a href="module-DistIO_ResponseArray-ResponseArray.html#sortBy">sortBy</a></li><li data-type='method'><a href="module-DistIO_ResponseArray-ResponseArray.html#unshift">unshift</a></li></ul></li><li><a href="module-DistIO_ResponseError-ResponseError.html">ResponseError</a></li><li><a href="module-DistIO_Response-Response.html">Response</a><ul class='methods'><li data-type='method'><a href="module-DistIO_Response-Response.html#pipe">pipe</a></li><li data-type='method'><a href="module-DistIO_Response-Response.html#toString">toString</a></li></ul></li><li><a href="module-DistIO_SlaveArray-SlaveArray.html">SlaveArray</a><ul class='methods'><li data-type='method'><a href="module-DistIO_SlaveArray-SlaveArray.html#close">close</a></li><li data-type='method'><a href="module-DistIO_SlaveArray-SlaveArray.html#do">do</a></li><li data-type='method'><a href="module-DistIO_SlaveArray-SlaveArray.html#each">each</a></li><li data-type='method'><a href="module-DistIO_SlaveArray-SlaveArray.html#exec">exec</a></li><li data-type='method'><a href="module-DistIO_SlaveArray-SlaveArray.html#exit">exit</a></li><li data-type='method'><a href="module-DistIO_SlaveArray-SlaveArray.html#kill">kill</a></li><li data-type='method'><a href="module-DistIO_SlaveArray-SlaveArray.html#push">push</a></li><li data-type='method'><a href="module-DistIO_SlaveArray-SlaveArray.html#shutdown">shutdown</a></li><li data-type='method'><a href="module-DistIO_SlaveArray-SlaveArray.html#then">then</a></li><li data-type='method'><a href="module-DistIO_SlaveArray-SlaveArray.html#unshift">unshift</a></li></ul></li><li><a href="module-DistIO_SlaveChildProcess-SlaveChildProcess.html">SlaveChildProcess</a><ul class='methods'><li data-type='method'><a href="module-DistIO_SlaveChildProcess-SlaveChildProcess.html#.isMasterMessage">isMasterMessage</a></li><li data-type='method'><a href="module-DistIO_SlaveChildProcess-SlaveChildProcess.html#invokeTaskListener">invokeTaskListener</a></li><li data-type='method'><a href="module-DistIO_SlaveChildProcess-SlaveChildProcess.html#pause">pause</a></li><li data-type='method'><a href="module-DistIO_SlaveChildProcess-SlaveChildProcess.html#resume">resume</a></li><li data-type='method'><a href="module-DistIO_SlaveChildProcess-SlaveChildProcess.html#task">task</a></li></ul></li><li><a href="module-DistIO_Slave-Slave.html">Slave</a><ul class='methods'><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getAllBusySlaves">getAllBusySlaves</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getAllIdleSlaves">getAllIdleSlaves</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getAllSlaves">getAllSlaves</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getLeastBusy">getLeastBusy</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getSlave">getSlave</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getSlavesInGroup">getSlavesInGroup</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getSlavesWithPath">getSlavesWithPath</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getSlaveWithAlias">getSlaveWithAlias</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getSlaveWithId">getSlaveWithId</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#ack">ack</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#close">close</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#do">do</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#exec">exec</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#exit">exit</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#kill">kill</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#noop">noop</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#shutdown">shutdown</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#then">then</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#toString">toString</a></li></ul></li><li><a href="module-DistIO_TimeoutResponse-TimeoutResponse.html">TimeoutResponse</a></li><li><a href="module-DistIO_Workpool-Workpool.html">Workpool</a><ul class='methods'><li data-type='method'><a href="module-DistIO_Workpool-Workpool.html#addTask">addTask</a></li><li data-type='method'><a href="module-DistIO_Workpool-Workpool.html#addWhileTask">addWhileTask</a></li><li data-type='method'><a href="module-DistIO_Workpool-Workpool.html#do">do</a></li><li data-type='method'><a href="module-DistIO_Workpool-Workpool.html#nextSlave">nextSlave</a></li><li data-type='method'><a href="module-DistIO_Workpool-Workpool.html#tickTaskQueue">tickTaskQueue</a></li><li data-type='method'><a href="module-DistIO_Workpool-Workpool.html#while">while</a></li></ul></li><li><a href="module-DistIO-DistIO.html">DistIO</a></li></ul><h3>Modules</h3><ul><li><a href="module-DistIO.html">DistIO</a></li><li><a href="module-DistIO_Commands.html">DistIO/Commands</a></li><li><a href="module-DistIO_Master.html">DistIO/Master</a><ul class='methods'><li data-type='method'><a href="module-DistIO_Master.html#~flattenSlaveList">flattenSlaveList</a></li><li data-type='method'><a href="module-DistIO_Master.html#~idleInList">idleInList</a></li><li data-type='method'><a href="module-DistIO_Master.html#~inGroup">inGroup</a></li><li data-type='method'><a href="module-DistIO_Master.html#~leastBusyInGroup">leastBusyInGroup</a></li><li data-type='method'><a href="module-DistIO_Master.html#~leastBusyInList">leastBusyInList</a></li><li data-type='method'><a href="module-DistIO_Master.html#~notInGroup">notInGroup</a></li><li data-type='method'><a href="module-DistIO_Master.html#~removeTask">removeTask</a></li><li data-type='method'><a href="module-DistIO_Master.html#~removeTask">removeTask</a></li><li data-type='method'><a href="module-DistIO_Master.html#~task">task</a></li><li data-type='method'><a href="module-DistIO_Master.html#~validateCommand">validateCommand</a></li></ul></li><li><a href="module-DistIO_Request.html">DistIO/Request</a></li><li><a href="module-DistIO_Response.html">DistIO/Response</a></li><li><a href="module-DistIO_ResponseArray.html">DistIO/ResponseArray</a><ul class='methods'><li data-type='method'><a href="module-DistIO_ResponseArray.html#~validateArgumentsAreAllResponses">validateArgumentsAreAllResponses</a></li></ul></li><li><a href="module-DistIO_ResponseError.html">DistIO/ResponseError</a></li><li><a href="module-DistIO_Slave.html">DistIO/Slave</a><ul class='methods'><li data-type='method'><a href="module-DistIO_Slave.html#~canInteract">canInteract</a></li><li data-type='method'><a href="module-DistIO_Slave.html#~cleanupSlaveReferences">cleanupSlaveReferences</a></li><li data-type='method'><a href="module-DistIO_Slave.html#~initializeSlaveEventsWithSlaveAndChildProcess">initializeSlaveEventsWithSlaveAndChildProcess</a></li><li data-type='method'><a href="module-DistIO_Slave.html#~isSlaveExceptionMessage">isSlaveExceptionMessage</a></li><li data-type='method'><a href="module-DistIO_Slave.html#~isSlaveMessage">isSlaveMessage</a></li><li data-type='method'><a href="module-DistIO_Slave.html#~sendCommandMessageToChildWithMetadata">sendCommandMessageToChildWithMetadata</a></li><li data-type='method'><a href="module-DistIO_Slave.html#~slaveMessageListener">slaveMessageListener</a></li></ul></li><li><a href="module-DistIO_SlaveArray.html">DistIO/SlaveArray</a><ul class='methods'><li data-type='method'><a href="module-DistIO_SlaveArray.html#~validateArgumentsAreAllSlaves">validateArgumentsAreAllSlaves</a></li></ul></li><li><a href="module-DistIO_SlaveChildProcess.html">DistIO/SlaveChildProcess</a><ul class='methods'><li data-type='method'><a href="module-DistIO_SlaveChildProcess.html#~sendExceptionMessageToMaster">sendExceptionMessageToMaster</a></li><li data-type='method'><a href="module-DistIO_SlaveChildProcess.html#~sendMessageToMaster">sendMessageToMaster</a></li><li data-type='method'><a href="module-DistIO_SlaveChildProcess.html#~slaveMessageListener">slaveMessageListener</a></li></ul></li><li><a href="module-DistIO_TimeoutResponse.html">DistIO/TimeoutResponse</a></li><li><a href="module-DistIO_Workpool.html">DistIO/Workpool</a></li></ul><h3>Events</h3><ul><li><a href="module-DistIO_SlaveChildProcess.html#~event:closerequested">close requested</a></li><li><a href="module-DistIO_Slave.html#~event:closed">closed</a></li><li><a href="module-DistIO_Slave.html#~event:exited">exited</a></li><li><a href="module-DistIO_Slave.html#~event:killed">killed</a></li><li><a href="module-DistIO_SlaveChildProcess.html#~event:paused">paused</a></li><li><a href="module-DistIO_Slave.html#~event:post-sent">post-sent</a></li><li><a href="module-DistIO_Slave.html#~event:pre-send">pre-send</a></li><li><a href="module-DistIO_Slave.html#~event:response">response</a></li><li><a href="module-DistIO_SlaveChildProcess.html#~event:resumed">resumed</a></li><li><a href="module-DistIO_SlaveChildProcess.html#~event:sendingexception">sending exception</a></li><li><a href="module-DistIO_SlaveChildProcess.html#~event:sendingmessage">sending message</a></li><li><a href="module-DistIO_Slave.html#~event:shutting-down">shutting-down</a></li><li><a href="module-DistIO_Master.html#~event:slavecreated">slave created</a></li><li><a href="module-DistIO_SlaveChildProcess.html#~event:taskcompleted">task completed</a></li><li><a href="module-DistIO_SlaveChildProcess.html#~event:taskstarted">task started</a></li><li><a href="module-DistIO_Slave.html#~event:uncaughtException">uncaughtException</a></li></ul><h3>Namespaces</h3><ul><li><a href="module-DistIO_Request-RequestProtected.html">RequestProtected</a></li><li><a href="module-DistIO_Slave-SlaveOptions.html">SlaveOptions</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">lib/Workpool.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file
 * Includes the Workpool class, an implementation of the workpool distributed computing pattern.
 * @copyright Â© 2016 Jason James Pollman
 */

'use strict';

/**
 * @module DistIO/Workpool
 */

/**
 * Used to privatize members of the Workpool class.
 */
const workpool = Symbol();

const ResponseArray = require('./ResponseArray');

/**
 * An abstraction around the parallel, distrubuted computing workpool pattern.
 */
class Workpool {
  /**
   * @param {...Slave} slaves The list of slaves to start this workpool with.
   */
  constructor(...slaves) {
    const queue = [];
    this[workpool] = { lastIndex: -1, slaves, queue };

    if (slaves.length === 0) throw new Error('No slaves given to start workpool with!');

    slaves.forEach(s => {
      // Setup a listener for when a slave receives a response to pop the next task of the queue
      // and execute it while there are idle slaves.
      s.on('response', () => this.tickTaskQueue());
    });
  }

  /**
   * "Ticks" the task queue (invokes the next task to be done)
   * @return {undefined}
   */
  tickTaskQueue() {
    if (this[workpool].queue.length > 0) this[workpool].queue.shift()();
  }

  /**
   * Adds a "while" workpool task to the task queue.
   * @param {Function} predicate The predicate from the .while() call.
   * @param {String} command The command to execute.
   * @param {*} data Data for the command.
   * @param {Object} meta Metadata for the command.
   * @param {Function=} done An optional callback for completion.
   * @return {Promise} A promise for completion.
   */
  addWhileTask(predicate, command, data, meta, done) {
    if (data instanceof Function) data = undefined;
    if (meta instanceof Function) meta = undefined;

    let i = 0;
    let predicateFailed = false;
    let received = 0;
    let sent = 0;
    let executeWithIdle = null;

    const responses = new ResponseArray();

    return new Promise((resolve, reject) => {
      const ifPredicatePassesExecWithSlave = (s) => {
        if (!predicateFailed &amp;&amp; predicate(i++, responses)) {
          sent++;
          s.exec(command, data, meta)
            .then(res => {
              ++received;
              responses.push(res);
              if (received === sent &amp;&amp; predicateFailed) {
                resolve(responses);
                done.call(this, null, responses);
              } else {
                this[workpool].queue.push(executeWithIdle);
                this.tickTaskQueue();
              }
            })
            .catch(e => {
              done.call(this, e, null);
              reject(e);
            });
        } else {
          predicateFailed = true;
          if (received === sent) {
            resolve(responses);
            done.call(this, null, responses);
          }
        }
      };

      executeWithIdle = () => {
        const idleSlaves = require('./Master').slaves // eslint-disable-line global-require
          .idleInList(...this[workpool].slaves);

        if (idleSlaves.length === 0) {
          this[workpool].queue.unshift(executeWithIdle);
        } else {
          idleSlaves.forEach(s => ifPredicatePassesExecWithSlave(s));
        }
      };

      this[workpool].queue.push(executeWithIdle);
      this.tickTaskQueue();
    });
  }

  /**
   * Retrieves the next slave that should do work in the workpool.
   * If no slaves are available to do work, then null will be returned.
   * @return {Slave|Null} A slave that's ready for work, or null.
   */
  nextSlave() {
    if (this[workpool].lastIndex === this[workpool].slaves.length - 1) this[workpool].lastIndex = -1;

    const slaves = require('./Master').slaves // eslint-disable-line global-require
      .idleInList(...this[workpool].slaves);

    let slave;
    if (slaves.length > 1) {
      slave = slaves
      ._.where(s => this[workpool].slaves.indexOf(s) > this[workpool].lastIndex)
      ._.first();
    } else if (slaves.length === 1) {
      slave = slaves[0];
    }


    if (slave) this[workpool].lastIndex = this[workpool].slaves.indexOf(slave);
    return slave || null;
  }

  /**
   * Adds a task to the workpool queue.
   * @param {String} command The command to execute.
   * @param {*} data Data for the command.
   * @param {Object} meta Metadata for the command.
   * @param {Function=} done An optional callback for completion.
   * @return {Promise} A promise for completion.
   */
  addTask(command, data, meta, done) {
    if (data instanceof Function) data = undefined;
    if (meta instanceof Function) meta = undefined;

    return new Promise((resolve, reject) => {
      const doTask = () => {
        const s = this.nextSlave();
        if (s) {
          s.exec(command, data, meta)
            .then(res => {
              resolve(res);
              done.call(this, null, res);
            })
            .catch(e => {
              reject(e);
              done.call(this, e, null);
            });
        } else {
          this[workpool].queue.push(doTask);
        }
      };

      this[workpool].queue.push(doTask);
      this.tickTaskQueue();
    });
  }

  /**
   * Executes a while-loop style workpool task.
   * @param {Function} predicate A function, that when invoked will keep adding tasks to the workpool until
   * a falsy value is returned.
   * @return {Promise} The same promise returned from Workpool#addWhileTask
   */
  while(predicate) {
    if (!(predicate instanceof Function)) {
      throw new TypeError(
        `Workpool#while expected argument #0 (predicate) to be a function, but got ${typeof predicate}.`
      );
    } else {
      return {
        do: (command, ...rest) => {
          const done = rest._.getAndStripCallback();
          return this.addWhileTask(predicate, command, rest[0], rest[1], done);
        },
      };
    }
  }

  /**
   * Adds a task to the workpool queue.
   * @param {String} command The command to execute
   * @param {...*} rest The rest of the arguments to pass to Workpool#addTask
   * @return {Promise} The same promise returned from Workpool#addTask
   */
  do(command, ...rest) {
    const done = rest._.getAndStripCallback();
    return this.addTask(command, rest[0], rest[1], done);
  }
}

/**
 * The Workpool class.
 * @type {Function}
 */
module.exports = Workpool;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Sun Jun 12 2016 22:08:41 GMT-0400 (EDT) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
