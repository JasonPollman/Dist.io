<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/Request.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-DistIO_Master-Master.html">Master</a><ul class='methods'><li data-type='method'><a href="module-DistIO_Master-Master.html#broadcast">broadcast</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#close">close</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#createParallel">createParallel</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#createPipeline">createPipeline</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#createScatter">createScatter</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#createSlave">createSlave</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#createSlaves">createSlaves</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#createWorkpool">createWorkpool</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#getSlavesWithPath">getSlavesWithPath</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#getSlaveWithAlias">getSlaveWithAlias</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#getSlaveWithId">getSlaveWithId</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#kill">kill</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#shutdown">shutdown</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#slave">slave</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#slaveBelongsToGroup">slaveBelongsToGroup</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#tellSlave">tellSlave</a></li></ul></li><li><a href="module-DistIO_Request-Request.html">Request</a><ul class='methods'><li data-type='method'><a href="module-DistIO_Request-Request.html#clearTimeout">clearTimeout</a></li><li data-type='method'><a href="module-DistIO_Request-Request.html#hasTimedout">hasTimedout</a></li><li data-type='method'><a href="module-DistIO_Request-Request.html#onTimeout">onTimeout</a></li><li data-type='method'><a href="module-DistIO_Request-Request.html#send">send</a></li></ul></li><li><a href="module-DistIO_ResponseError-ResponseError.html">ResponseError</a></li><li><a href="module-DistIO_Response-Response.html">Response</a><ul class='methods'><li data-type='method'><a href="module-DistIO_Response-Response.html#pipe">pipe</a></li><li data-type='method'><a href="module-DistIO_Response-Response.html#toString">toString</a></li></ul></li><li><a href="module-DistIO_Response-ResponseArray.html">ResponseArray</a><ul class='methods'><li data-type='method'><a href="module-DistIO_Response-ResponseArray.html#each">each</a></li><li data-type='method'><a href="module-DistIO_Response-ResponseArray.html#joinValues">joinValues</a></li><li data-type='method'><a href="module-DistIO_Response-ResponseArray.html#push">push</a></li><li data-type='method'><a href="module-DistIO_Response-ResponseArray.html#sortBy">sortBy</a></li><li data-type='method'><a href="module-DistIO_Response-ResponseArray.html#unshift">unshift</a></li></ul></li><li><a href="module-DistIO_Response-SlaveArray.html">SlaveArray</a><ul class='methods'><li data-type='method'><a href="module-DistIO_Response-SlaveArray.html#close">close</a></li><li data-type='method'><a href="module-DistIO_Response-SlaveArray.html#do">do</a></li><li data-type='method'><a href="module-DistIO_Response-SlaveArray.html#each">each</a></li><li data-type='method'><a href="module-DistIO_Response-SlaveArray.html#exec">exec</a></li><li data-type='method'><a href="module-DistIO_Response-SlaveArray.html#exit">exit</a></li><li data-type='method'><a href="module-DistIO_Response-SlaveArray.html#kill">kill</a></li><li data-type='method'><a href="module-DistIO_Response-SlaveArray.html#push">push</a></li><li data-type='method'><a href="module-DistIO_Response-SlaveArray.html#shutdown">shutdown</a></li><li data-type='method'><a href="module-DistIO_Response-SlaveArray.html#then">then</a></li><li data-type='method'><a href="module-DistIO_Response-SlaveArray.html#unshift">unshift</a></li></ul></li><li><a href="module-DistIO_SlaveChildProcess-SlaveChildProcess.html">SlaveChildProcess</a><ul class='methods'><li data-type='method'><a href="module-DistIO_SlaveChildProcess-SlaveChildProcess.html#.isMasterMessage">isMasterMessage</a></li><li data-type='method'><a href="module-DistIO_SlaveChildProcess-SlaveChildProcess.html#invokeTaskListener">invokeTaskListener</a></li><li data-type='method'><a href="module-DistIO_SlaveChildProcess-SlaveChildProcess.html#task">task</a></li></ul></li><li><a href="module-DistIO_Slave-Slave.html">Slave</a><ul class='methods'><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getAllBusySlaves">getAllBusySlaves</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getAllIdleSlaves">getAllIdleSlaves</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getAllSlaves">getAllSlaves</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getLeastBusy">getLeastBusy</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getSlave">getSlave</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getSlavesInGroup">getSlavesInGroup</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getSlavesWithPath">getSlavesWithPath</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getSlaveWithAlias">getSlaveWithAlias</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getSlaveWithId">getSlaveWithId</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#ack">ack</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#close">close</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#do">do</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#exec">exec</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#exit">exit</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#kill">kill</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#noop">noop</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#shutdown">shutdown</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#then">then</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#toString">toString</a></li></ul></li><li><a href="module-DistIO_TimeoutResponse-TimeoutResponse.html">TimeoutResponse</a></li><li><a href="module-DistIO-DistIO.html">DistIO</a></li><li><a href="module-Workpool-Workpool.html">Workpool</a><ul class='methods'><li data-type='method'><a href="module-Workpool-Workpool.html#addTask">addTask</a></li><li data-type='method'><a href="module-Workpool-Workpool.html#addWhileTask">addWhileTask</a></li><li data-type='method'><a href="module-Workpool-Workpool.html#do">do</a></li><li data-type='method'><a href="module-Workpool-Workpool.html#nextSlave">nextSlave</a></li><li data-type='method'><a href="module-Workpool-Workpool.html#tickTaskQueue">tickTaskQueue</a></li><li data-type='method'><a href="module-Workpool-Workpool.html#while">while</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-DistIO.html">DistIO</a></li><li><a href="module-DistIO_Commands.html">DistIO/Commands</a></li><li><a href="module-DistIO_Master.html">DistIO/Master</a><ul class='methods'><li data-type='method'><a href="module-DistIO_Master.html#~flattenSlaveList">flattenSlaveList</a></li><li data-type='method'><a href="module-DistIO_Master.html#~idleInList">idleInList</a></li><li data-type='method'><a href="module-DistIO_Master.html#~inGroup">inGroup</a></li><li data-type='method'><a href="module-DistIO_Master.html#~leastBusyInGroup">leastBusyInGroup</a></li><li data-type='method'><a href="module-DistIO_Master.html#~leastBusyInList">leastBusyInList</a></li><li data-type='method'><a href="module-DistIO_Master.html#~notInGroup">notInGroup</a></li><li data-type='method'><a href="module-DistIO_Master.html#~task">task</a></li><li data-type='method'><a href="module-DistIO_Master.html#~validateCommand">validateCommand</a></li></ul></li><li><a href="module-DistIO_Request.html">DistIO/Request</a></li><li><a href="module-DistIO_Response.html">DistIO/Response</a><ul class='methods'><li data-type='method'><a href="module-DistIO_Response.html#~validateArgumentsAreAllResponses">validateArgumentsAreAllResponses</a></li><li data-type='method'><a href="module-DistIO_Response.html#~validateArgumentsAreAllSlaves">validateArgumentsAreAllSlaves</a></li></ul></li><li><a href="module-DistIO_ResponseError.html">DistIO/ResponseError</a></li><li><a href="module-DistIO_Slave.html">DistIO/Slave</a><ul class='methods'><li data-type='method'><a href="module-DistIO_Slave.html#~canInteract">canInteract</a></li><li data-type='method'><a href="module-DistIO_Slave.html#~cleanupSlaveReferences">cleanupSlaveReferences</a></li><li data-type='method'><a href="module-DistIO_Slave.html#~initializeSlaveEventsWithSlaveAndChildProcess">initializeSlaveEventsWithSlaveAndChildProcess</a></li><li data-type='method'><a href="module-DistIO_Slave.html#~isSlaveExceptionMessage">isSlaveExceptionMessage</a></li><li data-type='method'><a href="module-DistIO_Slave.html#~isSlaveMessage">isSlaveMessage</a></li><li data-type='method'><a href="module-DistIO_Slave.html#~sendCommandMessageToChildWithMetadata">sendCommandMessageToChildWithMetadata</a></li><li data-type='method'><a href="module-DistIO_Slave.html#~slaveMessageListener">slaveMessageListener</a></li></ul></li><li><a href="module-DistIO_SlaveChildProcess.html">DistIO/SlaveChildProcess</a><ul class='methods'><li data-type='method'><a href="module-DistIO_SlaveChildProcess.html#~sendExceptionMessageToMaster">sendExceptionMessageToMaster</a></li><li data-type='method'><a href="module-DistIO_SlaveChildProcess.html#~sendMessageToMaster">sendMessageToMaster</a></li><li data-type='method'><a href="module-DistIO_SlaveChildProcess.html#~slaveMessageListener">slaveMessageListener</a></li></ul></li><li><a href="module-DistIO_TimeoutResponse.html">DistIO/TimeoutResponse</a></li><li><a href="module-Workpool.html">Workpool</a></li></ul><h3>Events</h3><ul><li><a href="module-DistIO_Slave.html#~event:closed">closed</a></li><li><a href="module-DistIO_Slave.html#~event:exited">exited</a></li><li><a href="module-DistIO_Slave.html#~event:killed">killed</a></li><li><a href="module-DistIO_Slave.html#~event:post-sent">post-sent</a></li><li><a href="module-DistIO_Slave.html#~event:pre-send">pre-send</a></li><li><a href="module-DistIO_Slave.html#~event:response">response</a></li><li><a href="module-DistIO_SlaveChildProcess.html#~event:sendingexception">sending exception</a></li><li><a href="module-DistIO_SlaveChildProcess.html#~event:sendingmessage">sending message</a></li><li><a href="module-DistIO_Slave.html#~event:shutting-down">shutting-down</a></li><li><a href="module-DistIO_Master.html#~event:slavecreated">slave created</a></li><li><a href="module-DistIO_SlaveChildProcess.html#~event:taskcompleted">task completed</a></li><li><a href="module-DistIO_SlaveChildProcess.html#~event:taskstarted">task started</a></li><li><a href="module-DistIO_Slave.html#~event:uncaughtException">uncaughtException</a></li></ul><h3>Namespaces</h3><ul><li><a href="module-DistIO_Request-RequestProtected.html">RequestProtected</a></li><li><a href="module-DistIO_Slave-SlaveOptions.html">SlaveOptions</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">lib/Request.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file
 * A reprentation of a request. All request actions are defined in the Request class.
 * @copyright © 2016 Jason James Pollman
 */

'use strict';
require('proto-lib').get('_');

/**
 * @module DistIO/Request
 */

const Commands = require('./Commands');
const Response = require('./Response');

/**
 * Used by the request class to privatize variables.
 */
const request = Symbol();

/**
 * An accumulator for request ids.
 * @type {Number}
 */
let rids = 0;

/**
 * A simple class that represents a request.
 * @constructor
 */
class Request {
  /**
   * Slave constructor.
   * @param {Slave} slave The slave associated with this request.
   * @param {String} command The command for this request.
   * @param {Object} meta Meta data for this request.
   * @param {Object} data The data to send with this request.
   * @param {String} secretId A string to prevent accidentally sending a slave request.
   * @param {Number} secretNumber A number to help prevent accidentally sending a slave request by mistake.
   * @param {Symbol} slaveSymbol The private slave symbol.
   * @param {Function=} callback The callback to invoke when this request is responded to.
   * @return {Slave} The newly created slave instance.
   */
  constructor(slave, command, meta, data, secretId, secretNumber, slaveSymbol, callback) {
    // Check arguments...
    if (!(slave instanceof require('./Slave'))) { // eslint-disable-line global-require
      throw new TypeError('Request argument #0 (slave) expected a an instanceof Slave.');
    } else if (typeof secretId !== 'string') {
      throw new TypeError(`Request argument #4 (secretId) expected a string, but got ${typeof secretId}.`);
    } else if (typeof secretNumber !== 'number') {
      throw new TypeError(`Request argument #5 (secretNumber) expected a number, but got ${typeof secretNumber}.`);
    } else if (typeof meta !== 'object') {
      throw new TypeError(`Request argument #2 (meta) expected an object, but got ${typeof object}.`);
    }

    meta = meta || {};

    // Validate command argument...
    switch (command) {
      // The command to gracefully exit the slave process.
      case Commands.EXIT:
        command = '__dist.io__exit__';
        break;

      // The command to send an acknowledgement to the slave.
      case Commands.ACK:
        command = '__dist.io__ack__';
        break;

      // Sends a no-op command.
      case Commands.NULL:
        command = '__dist.io__null__';
        break;

      // Sends a user command.
      default:
        if (typeof command !== 'string') {
          throw new TypeError(`Request constructor argument #0 (command) expect a string, but got ${typeof command}.`);
        }
    }

    const created = Date.now();
    const timeout = meta.timeout ? meta.timeout._.getNumeric() : null;

    /**
     * Protected properties for this Request instance.
     * @namespace RequestProtected
     */
    this[request] = {
      /**
       * The request id.
       * @type {Number}
       */
      rid: rids++,

      /**
       * The time the request was created in nanoseconds.
       * @type {Number}
       */
      created,

      /**
       * The slave process associated with this request.
       * @type {Slave}
       */
      slave,

      /**
       * The command for this request.
       * @type {String}
       */
      command,

      /**
       * Metadata for this request.
       * @type {Object}
       */
      meta,

      /**
       * The data to send with this request.
       * @type {Object}
       */
      data,

      /**
       * The callback to be invoked when this request is complete.
       * @type {Function}
       * @return {undefined}
       */
      callback: callback instanceof Function ? callback : () => {},

      /**
       * The duration before this request times out. &lt;= Zero means never.
       * @type {Object}
       */
      ttl: 0,

      /**
       * The Timeout object associated with this request (the actual timeout).
       * @type {Timeout}
       */
      timeout: null,

      /**
       * A function to invoke when the request times out.
       * @type {Function}
       * @return {undefined}
       */
      onTimeout: () => {},

      /**
       * The secret id from the Slave module.
       * @type {String}
       */
      secretId,

      /**
       * The secret tiem from the Slave module.
       * @type {Number}
       */
      secretNumber,

      /**
       * The symbol object passed in by the slave process.
       * @type {Symbol}
       */
      slaveSymbol,
    };

    if (timeout &amp;&amp; timeout._.isNumeric()) {
      this[request].ttl = timeout;
      this[request].timeout = setTimeout(() => {
        this[request].onTimeout();
      }, timeout);
    }
  }

  /**
   * The request id.
   * @return {Number} The request id.
   */
  get id() {
    return this[request].rid;
  }

  /**
   * The request id (an alias for Request#id).
   * @return {Number} The request id.
   */
  get rid() {
    return this[request].rid;
  }

  /**
   * The request time to live.
   * @return {Number} The request TTL.
   */
  get ttl() {
    return this[request].ttl;
  }

  /**
   * The request's command
   * @return {String} The request's command.
   */
  get command() {
    return this[request].command;
  }

  /**
   * Returns the time the Request was created.
   * @return {Number} The time in nanoseconds.
   */
  get created() {
    return this[request].created;
  }

  /**
   * Returns the request's callback.
   * @return {Function} The callback to invoked when the response is received for this request.
   */
  get callback() {
    return this[request].callback;
  }

  /**
   * Sends the request.
   * @return {Request} The current request instance.
   */
  send() {
    const sendTime = Date.now();
    this[request].slave[this[request].slaveSymbol].process.send({
      sent: sendTime,
      rid: this[request].rid,
      for: this[request].slave.id,
      meta: this[request].meta,
      data: this[request].data,
      command: this[request].command,
      created: this[request].created,
      secretId: this[request].secretId,
      secretNumber: this[request].secretNumber,
      title: 'MasterIOMessage',
    });
    return this;
  }

  /**
   * Checks whether or not the Request has timedout.
   * @param {Response} response The received message.
   * @return {Boolean} True if the message has timedout, false otherwise.
   */
  hasTimedout(response) {
    if (!(response instanceof Response)) {
      throw new TypeError('Request#hasTimedout expected argument #0 (response) to be an instanceof Response.');
    }
    if (this.ttl !== 0 &amp;&amp; this[request].timeout &amp;&amp; this.ttl &lt; (response.received - this.created)) return true;
    return false;
  }

  /**
   * A callback that is invoked when the request times out.
   * @param {Function} callback The callback to invoked when the request times out.
   * @return {Request} The current request instance.
   */
  onTimeout(callback) {
    if (callback instanceof Function) this[request].onTimeout = callback;
    return this;
  }

  /**
   * Clears the Request timeout.
   * @return {Request} The current request instance.
   */
  clearTimeout() {
    clearTimeout(this[request].timeout);
    return this;
  }
}

/**
 * The Request class.
 * @type {Request}
 */
module.exports = Request;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Mon Jun 06 2016 22:34:27 GMT-0400 (EDT) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
