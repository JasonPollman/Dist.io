<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>lib/SlaveChildProcess.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-DistIO_Master-Master.html">Master</a><ul class='methods'><li data-type='method'><a href="module-DistIO_Master-Master.html#broadcast">broadcast</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#close">close</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#createParallel">createParallel</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#createPipeline">createPipeline</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#createScatter">createScatter</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#createSlave">createSlave</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#createSlaves">createSlaves</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#createWorkpool">createWorkpool</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#getSlavesWithPath">getSlavesWithPath</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#getSlaveWithAlias">getSlaveWithAlias</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#getSlaveWithId">getSlaveWithId</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#kill">kill</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#shutdown">shutdown</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#slave">slave</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#slaveBelongsToGroup">slaveBelongsToGroup</a></li><li data-type='method'><a href="module-DistIO_Master-Master.html#tellSlave">tellSlave</a></li></ul></li><li><a href="module-DistIO_Request-Request.html">Request</a><ul class='methods'><li data-type='method'><a href="module-DistIO_Request-Request.html#clearTimeout">clearTimeout</a></li><li data-type='method'><a href="module-DistIO_Request-Request.html#hasTimedout">hasTimedout</a></li><li data-type='method'><a href="module-DistIO_Request-Request.html#onTimeout">onTimeout</a></li><li data-type='method'><a href="module-DistIO_Request-Request.html#send">send</a></li></ul></li><li><a href="module-DistIO_ResponseError-ResponseError.html">ResponseError</a></li><li><a href="module-DistIO_Response-Response.html">Response</a><ul class='methods'><li data-type='method'><a href="module-DistIO_Response-Response.html#pipe">pipe</a></li><li data-type='method'><a href="module-DistIO_Response-Response.html#toString">toString</a></li></ul></li><li><a href="module-DistIO_Response-ResponseArray.html">ResponseArray</a><ul class='methods'><li data-type='method'><a href="module-DistIO_Response-ResponseArray.html#each">each</a></li><li data-type='method'><a href="module-DistIO_Response-ResponseArray.html#joinValues">joinValues</a></li><li data-type='method'><a href="module-DistIO_Response-ResponseArray.html#push">push</a></li><li data-type='method'><a href="module-DistIO_Response-ResponseArray.html#sortBy">sortBy</a></li><li data-type='method'><a href="module-DistIO_Response-ResponseArray.html#unshift">unshift</a></li></ul></li><li><a href="module-DistIO_Response-SlaveArray.html">SlaveArray</a><ul class='methods'><li data-type='method'><a href="module-DistIO_Response-SlaveArray.html#close">close</a></li><li data-type='method'><a href="module-DistIO_Response-SlaveArray.html#do">do</a></li><li data-type='method'><a href="module-DistIO_Response-SlaveArray.html#each">each</a></li><li data-type='method'><a href="module-DistIO_Response-SlaveArray.html#exec">exec</a></li><li data-type='method'><a href="module-DistIO_Response-SlaveArray.html#exit">exit</a></li><li data-type='method'><a href="module-DistIO_Response-SlaveArray.html#kill">kill</a></li><li data-type='method'><a href="module-DistIO_Response-SlaveArray.html#push">push</a></li><li data-type='method'><a href="module-DistIO_Response-SlaveArray.html#shutdown">shutdown</a></li><li data-type='method'><a href="module-DistIO_Response-SlaveArray.html#then">then</a></li><li data-type='method'><a href="module-DistIO_Response-SlaveArray.html#unshift">unshift</a></li></ul></li><li><a href="module-DistIO_SlaveChildProcess-SlaveChildProcess.html">SlaveChildProcess</a><ul class='methods'><li data-type='method'><a href="module-DistIO_SlaveChildProcess-SlaveChildProcess.html#.isMasterMessage">isMasterMessage</a></li><li data-type='method'><a href="module-DistIO_SlaveChildProcess-SlaveChildProcess.html#invokeTaskListener">invokeTaskListener</a></li><li data-type='method'><a href="module-DistIO_SlaveChildProcess-SlaveChildProcess.html#task">task</a></li></ul></li><li><a href="module-DistIO_Slave-Slave.html">Slave</a><ul class='methods'><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getAllBusySlaves">getAllBusySlaves</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getAllIdleSlaves">getAllIdleSlaves</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getAllSlaves">getAllSlaves</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getLeastBusy">getLeastBusy</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getSlave">getSlave</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getSlavesInGroup">getSlavesInGroup</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getSlavesWithPath">getSlavesWithPath</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getSlaveWithAlias">getSlaveWithAlias</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#.getSlaveWithId">getSlaveWithId</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#ack">ack</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#close">close</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#do">do</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#exec">exec</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#exit">exit</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#kill">kill</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#noop">noop</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#shutdown">shutdown</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#then">then</a></li><li data-type='method'><a href="module-DistIO_Slave-Slave.html#toString">toString</a></li></ul></li><li><a href="module-DistIO_TimeoutResponse-TimeoutResponse.html">TimeoutResponse</a></li><li><a href="module-DistIO-DistIO.html">DistIO</a></li><li><a href="module-Workpool-Workpool.html">Workpool</a><ul class='methods'><li data-type='method'><a href="module-Workpool-Workpool.html#addTask">addTask</a></li><li data-type='method'><a href="module-Workpool-Workpool.html#addWhileTask">addWhileTask</a></li><li data-type='method'><a href="module-Workpool-Workpool.html#do">do</a></li><li data-type='method'><a href="module-Workpool-Workpool.html#nextSlave">nextSlave</a></li><li data-type='method'><a href="module-Workpool-Workpool.html#tickTaskQueue">tickTaskQueue</a></li><li data-type='method'><a href="module-Workpool-Workpool.html#while">while</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-DistIO.html">DistIO</a></li><li><a href="module-DistIO_Commands.html">DistIO/Commands</a></li><li><a href="module-DistIO_Master.html">DistIO/Master</a><ul class='methods'><li data-type='method'><a href="module-DistIO_Master.html#~flattenSlaveList">flattenSlaveList</a></li><li data-type='method'><a href="module-DistIO_Master.html#~idleInList">idleInList</a></li><li data-type='method'><a href="module-DistIO_Master.html#~inGroup">inGroup</a></li><li data-type='method'><a href="module-DistIO_Master.html#~leastBusyInGroup">leastBusyInGroup</a></li><li data-type='method'><a href="module-DistIO_Master.html#~leastBusyInList">leastBusyInList</a></li><li data-type='method'><a href="module-DistIO_Master.html#~notInGroup">notInGroup</a></li><li data-type='method'><a href="module-DistIO_Master.html#~task">task</a></li><li data-type='method'><a href="module-DistIO_Master.html#~validateCommand">validateCommand</a></li></ul></li><li><a href="module-DistIO_Request.html">DistIO/Request</a></li><li><a href="module-DistIO_Response.html">DistIO/Response</a><ul class='methods'><li data-type='method'><a href="module-DistIO_Response.html#~validateArgumentsAreAllResponses">validateArgumentsAreAllResponses</a></li><li data-type='method'><a href="module-DistIO_Response.html#~validateArgumentsAreAllSlaves">validateArgumentsAreAllSlaves</a></li></ul></li><li><a href="module-DistIO_ResponseError.html">DistIO/ResponseError</a></li><li><a href="module-DistIO_Slave.html">DistIO/Slave</a><ul class='methods'><li data-type='method'><a href="module-DistIO_Slave.html#~canInteract">canInteract</a></li><li data-type='method'><a href="module-DistIO_Slave.html#~cleanupSlaveReferences">cleanupSlaveReferences</a></li><li data-type='method'><a href="module-DistIO_Slave.html#~initializeSlaveEventsWithSlaveAndChildProcess">initializeSlaveEventsWithSlaveAndChildProcess</a></li><li data-type='method'><a href="module-DistIO_Slave.html#~isSlaveExceptionMessage">isSlaveExceptionMessage</a></li><li data-type='method'><a href="module-DistIO_Slave.html#~isSlaveMessage">isSlaveMessage</a></li><li data-type='method'><a href="module-DistIO_Slave.html#~sendCommandMessageToChildWithMetadata">sendCommandMessageToChildWithMetadata</a></li><li data-type='method'><a href="module-DistIO_Slave.html#~slaveMessageListener">slaveMessageListener</a></li></ul></li><li><a href="module-DistIO_SlaveChildProcess.html">DistIO/SlaveChildProcess</a><ul class='methods'><li data-type='method'><a href="module-DistIO_SlaveChildProcess.html#~sendExceptionMessageToMaster">sendExceptionMessageToMaster</a></li><li data-type='method'><a href="module-DistIO_SlaveChildProcess.html#~sendMessageToMaster">sendMessageToMaster</a></li><li data-type='method'><a href="module-DistIO_SlaveChildProcess.html#~slaveMessageListener">slaveMessageListener</a></li></ul></li><li><a href="module-DistIO_TimeoutResponse.html">DistIO/TimeoutResponse</a></li><li><a href="module-Workpool.html">Workpool</a></li></ul><h3>Events</h3><ul><li><a href="module-DistIO_Slave.html#~event:closed">closed</a></li><li><a href="module-DistIO_Slave.html#~event:exited">exited</a></li><li><a href="module-DistIO_Slave.html#~event:killed">killed</a></li><li><a href="module-DistIO_Slave.html#~event:post-sent">post-sent</a></li><li><a href="module-DistIO_Slave.html#~event:pre-send">pre-send</a></li><li><a href="module-DistIO_Slave.html#~event:response">response</a></li><li><a href="module-DistIO_SlaveChildProcess.html#~event:sendingexception">sending exception</a></li><li><a href="module-DistIO_SlaveChildProcess.html#~event:sendingmessage">sending message</a></li><li><a href="module-DistIO_Slave.html#~event:shutting-down">shutting-down</a></li><li><a href="module-DistIO_Master.html#~event:slavecreated">slave created</a></li><li><a href="module-DistIO_SlaveChildProcess.html#~event:taskcompleted">task completed</a></li><li><a href="module-DistIO_SlaveChildProcess.html#~event:taskstarted">task started</a></li><li><a href="module-DistIO_Slave.html#~event:uncaughtException">uncaughtException</a></li></ul><h3>Namespaces</h3><ul><li><a href="module-DistIO_Request-RequestProtected.html">RequestProtected</a></li><li><a href="module-DistIO_Slave-SlaveOptions.html">SlaveOptions</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">lib/SlaveChildProcess.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file
 * The actual slave processes requre this file.
 * @copyright © 2016 Jason James Pollman
 */

'use strict';
require('proto-lib').get('_');

/**
 * @module DistIO/SlaveChildProcess
 */

const EventEmitter = require('events').EventEmitter;
const args = require('minimist')(process.argv.slice(2), {
  number: ['dist-io-slave-id'],
  string: ['dist-io-slave-alias', 'dist-io-slave-title'],
});

/**
 * Used by the SlaveChildProcess class to privatize properties.
 */
const slave = Symbol();

/**
 * The time this process was started.
 * @type {Number}
 */
const INIT = Date.now();

/**
 * A slave worker process controller.
 * @constructor
 * @extends EventEmitter
 */
class SlaveChildProcess extends EventEmitter {
  /**
   * SlaveChildProcess constructor.
   * @return {SlaveChildProcess} The newly created SlaveChildProcess object.
   */
  constructor() {
    super();
    this[slave] = {
      id: args['dist-io-slave-id'],
      alias: args['dist-io-slave-alias'],
      tasks: {},
    };

    // Set the process title, if desired.
    if (typeof args['dist-io-slave-title'] === 'string') {
      process.title = args['dist-io-slave-title'];
    }

    // Change default process title...
    if (/node$/.test(process.title)) {
      process.title = `DistIOSlave-${this.id}-${this.alias}`;
    }

    this.task('__dist.io__ack__', (data, done, meta, m) => {
      const now = Date.now();
      const uptime = Date.now() - INIT;
      return done({
        from: this.id,
        sent: m.sent,
        responsed: now,
        started: INIT,
        uptime,
        message:
          `Slave acknowledgement from=${this.id}, received=${m.sent}, ` +
          `responded=${now}, started=${INIT}, uptime=${uptime}`,
        data,
        meta,
      });
    });

    this.task('__dist.io__null__', (data, done) => done(null));
    this.task('__dist.io__exit__', (data, done) => {
      process.removeListener('message', this[slave].messageListener);
      done(true);
    });
  }

  /**
   * Returns true if the message is from the master process.
   * @param {Object} m The message to inspect.
   * @return {Boolean} True if the message if from the master, false otherwise.
   */
  static isMasterMessage(m) {
    return typeof m === 'object'
      &amp;&amp; typeof m.rid === 'number'
      &amp;&amp; m.title === 'MasterIOMessage'
      &amp;&amp; typeof m.for === 'number'
      &amp;&amp; typeof m.command === 'string'
      &amp;&amp; typeof m.secretNumber === 'number'
      &amp;&amp; typeof m.secretId === 'string';
  }

  /**
   * Returns the slave's id.
   * @return {Number} The slave's id.
   */
  get id() {
    return this[slave].id;
  }

  /**
   * Returns the slave's alias.
   * @return {Number} The slave's alias.
   */
  get alias() {
    return this[slave].alias;
  }

  /**
   * Invoked when the slave receives an task command from the master.
   * @param {String} task The name of the task to execute.
   * @param {Object} meta Metadata from the master.
   * @param {*} data The data from the master.
   * @param {Object} m The original message sent by the master.
   * @return {Promise} A promise for completion.
   */
  invokeTaskListener(task, meta, data, m) {
    /**
     * Emitted right before a slave is called upon to do a task (just before the .task() invocation).
     * @event task started
     * @argument {String} task The name of the task that was completed.
     * @argument {*} data The data to send back to the master.
     * @argument {Object} The metadata, which will also be sent back to the master.
     */
    this.emit('task started', task, data, meta);

    return new Promise((resolve, reject) => {
      if (this[slave].tasks[task] instanceof Function) {
        try {
          this[slave].tasks[task].call(this, data, res => {
            if (res instanceof Error) {
              this.emit('task completed', task, res, null, data, meta);
              reject(res);
            } else {
              this.emit('task completed', task, null, res, data, meta);
              resolve(res);
            }
          }, meta, m);
        } catch (e) {
          /**
           * Emitted when a slave process finishes a task, right before the data is sent back to the master.
           * @event task completed
           * @argument {String} task The name of the task that was completed.
           * @argument {Error|null} e An error, if one occured during the task
           * @argument {*} res The response value that's being sent back to the master.
           * @argument {*} data The data sent from the master.
           * @argument {Object} The metadata sent from the master.
           */
          this.emit('task completed', task, e, null, data, meta);
          reject(e);
        }
      } else {
        const err = new ReferenceError(`Slave #${this.id} does not listen to task "${task}"`);
        this.emit('task completed', task, err, null, data, meta);
        reject(err);
      }
    });
  }

  /**
   * Adds a task listener for this slave.
   * @param {String} name The name of the task.
   * @param {Function} listener The listener to attach.
   * @return {SlaveChildProcess} The current slave child process.
   */
  task(name, listener) {
    if (typeof name === 'string' &amp;&amp; listener instanceof Function) {
      if (!this[slave].tasks[name]) {
        this[slave].tasks[name] = listener;
      } else {
        throw new TypeError(`Slave already has a listener for task ${name}`);
      }
    } else {
      throw new TypeError('Slave#task: Invalid arguments. Name should be a string, and listener a function.');
    }
    return this;
  }
}

/**
 * A singleton instanceof SlaveChildProcess
 * @type {SlaveChildProcess}
 */
const slaveInstance = new SlaveChildProcess();

/**
 * Sends the response message to the master process.
 * @param {Object} req The original request from the master.
 * @param {Object} res The results from the request execution.
 * @return {undefined}
 */
function sendMessageToMaster(req, res) {
  // The actual message to send to the master process...
  const response = {
    title: 'SlaveIOResponse',
    sent: Date.now(),
    request: req,
    error: null,
    data: undefined,
    [req.secretId]: req.secretNumber,
  };

  // Remove these as the above will be exposed.
  delete req.secretId;
  delete req.secretNumber;

  // Add each result, either as an error, or data.
  if (res instanceof Error) {
    response.error = { message: res.message, stack: res.stack, name: res.name };
  } else {
    response.data = res;
  }

  // Send the message to the parent process...

  /**
   * Emitted when a slave process is sending a message to it's master
   * @event sending message
   * @argument {Obkect} response The response message the slave is sending.
   */
  slaveInstance.emit('sending message', response);

  if (process.send instanceof Function) {
    process.send(response);
  } else {
    throw new Error('Fatal: Disconnected from master process.');
  }
}

/**
 * Sends an exception response message to the master process.
 * @param {Object} res The data to send.
 * @return {undefined}
 */
function sendExceptionMessageToMaster(res) {
  /**
   * Emitted when a slave process is sending an exception to it's master
   * @event sending exception
   * @argument {Obkect} exception The exception response object the slave is sending.
   */
  slaveInstance.emit('sending exception', res);

  if (process.send instanceof Function) {
    process.send(res);
  } else {
    throw new Error('Fatal: Disconnected from master process.');
  }
}

/**
 * A listener attached to process.on('message', ...).
 * @param {*} m The message contents.
 * @return {undefined}
 */
function slaveMessageListener(m) {
  if (SlaveChildProcess.isMasterMessage(m)) {
    slaveInstance.invokeTaskListener(m.command, m.meta, m.data, m)
      .then(res => {
        sendMessageToMaster(m, res);
      })
      .catch(e => {
        sendMessageToMaster(m, e);
      });
  }
}

// Send an error on uncaught exception
process.on('uncaughtException', (e) => {
  sendExceptionMessageToMaster({
    from: slaveInstance.id,
    title: 'SlaveIOException',
    sent: Date.now(),
    error: { message: e.message, stack: e.stack, name: e.name },
  });
});

// Listens for master messages.
process.on('message', slaveMessageListener);
// Attach this to the slave child process instance, so we can remove it later.
slaveInstance[slave].messageListener = slaveMessageListener;

/**
 * A singleton instance of the SlaveChildProcess class.
 * @type {SlaveChildProcess}
 */
module.exports = slaveInstance;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Mon Jun 06 2016 22:34:27 GMT-0400 (EDT) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
